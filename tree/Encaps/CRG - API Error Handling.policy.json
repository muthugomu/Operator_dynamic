{
  "goid": "4d93b941548c2fff647c18a84bcc68e0",
  "guid": "78172f90-5b29-415d-b9e8-e8717fe38a6e",
  "name": "CRG - API Error Handling",
  "checksum": "7528836951826441e26d7ac796056c4729609afe",
  "folderPath": "/Encaps",
  "soap": false,
  "policy": {
    "xml": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"################################################################################\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"################################################################################\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"## This policy should only be used in an encapsulated assertion\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"##\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"## USAGE: Include in any Service published on the Gateway which requires a valid SSO Token to exist\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"## RECOMMENDATION:  Set ErrorStatus= '401'\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"## RECOMMENDATION:  Set ErrorMessage= 'Unauthorized''\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"##\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"## GUI INPUT:  ${errorComponent} , ${errorLog}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"## DYNAMIC INPUT:  ${httpRouting.url}, ${httpRouting.reasonCode}, ${httpRouting.latency}, ${Access-Token.message}, ${clientIpAddress}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"## OUTPUT:  ${errorStatus}, ${errorMessage}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"##\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"##  LOG:  ${errorLog}, must be defined in GUI and match a configured Log Sink\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"##\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"## v1.0 - Robert Brodie, Alldata\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"################################################################################\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"################################################################################\"/>\n        </L7p:CommentAssertion>\n        <L7p:AuditDetailAssertion>\n            <L7p:CustomLoggerSuffix stringValue=\"error.handler\"/>\n            <L7p:Detail stringValue=\"Policy Fragment: Alldata - API Error Handling\"/>\n            <L7p:Level stringValue=\"FINE\"/>\n            <L7p:LoggingOnly booleanValue=\"true\"/>\n        </L7p:AuditDetailAssertion>\n        <wsp:All wsp:Usage=\"Required\">\n            <wsp:OneOrMore wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// Check if log file has been specified\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${errorLog}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"string\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Negated booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:SetVariable>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// Set default error log file\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:Base64Expression stringValue=\"YXBpLmVycm9ycw==\"/>\n                    <L7p:VariableToSet stringValue=\"errorLog\"/>\n                </L7p:SetVariable>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// Set error log file to default if not specified\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:OneOrMore>\n            <L7p:AuditDetailAssertion>\n                <L7p:CustomLoggerSuffix stringValue=\"error.handler\"/>\n                <L7p:Detail stringValueReference=\"inline\"><![CDATA[Logging to ${errorLog}\nResponse:\n${response.mainpart}]]></L7p:Detail>\n                <L7p:Level stringValue=\"WARNING\"/>\n                <L7p:LoggingOnly booleanValue=\"true\"/>\n            </L7p:AuditDetailAssertion>\n            <L7p:SetVariable>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// Return 500 for all non-handled errors\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:Base64Expression stringValue=\"NTAw\"/>\n                <L7p:VariableToSet stringValue=\"errorStatus\"/>\n            </L7p:SetVariable>\n            <L7p:SetVariable>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// Return 'Service unavailable' for all non-handled errors\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:Base64Expression stringValue=\"eyJtZXNzYWdlIjogIlNlcnZpY2UgVW5hdmFpbGFibGUifQ==\"/>\n                <L7p:VariableToSet stringValue=\"errorMessage\"/>\n            </L7p:SetVariable>\n            <L7p:Encapsulated>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// Get username and ClientTxnId from SSO JWT for logging\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"4242cc04-8101-4445-86d5-87a50f806ad1\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"Alldata - Extract SSO JWT for log\"/>\n            </L7p:Encapsulated>\n            <L7p:AuditDetailAssertion>\n                <L7p:CustomLoggerSuffix stringValue=\"${errorLog}\"/>\n                <L7p:Detail stringValue=\"time=${request.time} | service=${request.http.uri} | status=${httpRouting.reasonCode} | clientip=${request.tcp.RemoteAddress} | component='${errorComponent}' | reason='API returned ${httpRouting.reasonCode}' | latency=${httpRouting.latency} | apiUrl='${httpRouting.url}' | clientTxnId='${clientTxnId}' | user='${username}' | response='${response.mainpart}'\"/>\n                <L7p:Enabled booleanValue=\"false\"/>\n                <L7p:Level stringValue=\"WARNING\"/>\n                <L7p:LoggingOnly booleanValue=\"true\"/>\n            </L7p:AuditDetailAssertion>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"db5e4ebf-3a57-434d-bd4d-60cb148b276c\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"Alldata - Log API Error Events\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logClientIP\"/>\n                        <L7p:value stringValue=\"${clientIpAddress}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logComponent\"/>\n                        <L7p:value stringValue=\"${errorComponent}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logLatency\"/>\n                        <L7p:value stringValue=\"${httpRouting.latency}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logPackage\"/>\n                        <L7p:value stringValue=\"${errorLog}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logResponse\"/>\n                        <L7p:value stringValue=\"${response.mainpart}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logStatusCode\"/>\n                        <L7p:value stringValue=\"${httpRouting.reasonCode}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logStatusMessage\"/>\n                        <L7p:value stringValue=\"API returned ${httpRouting.reasonCode}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logUri\"/>\n                        <L7p:value stringValue=\"${httpRouting.url}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"logUsername\"/>\n                        <L7p:value stringValue=\"${username}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"4ad9d984-3538-4f52-add2-80c801902703\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"Alldata - SSO CORS Response\"/>\n            </L7p:Encapsulated>\n            <L7p:FalseAssertion/>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                        <L7p:value stringValue=\"ERROR HANDLING\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// Response code 500 or Unknown\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:All>\n    </wsp:All>\n</wsp:Policy>\n"
  }
}